<!DOCTYPE html>
<html lang="en" class="no-js" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="sidebar1">
    <head>
        <title>Friend Management Sidebar</title>
        <style>
            /* Sidebar styles */
            #sidebar {
                width: 300px;
                position: fixed;
                top: 0;
                right: -300px; /* Hidden by default */
                height: 100%;
                background-color: #333;
                color: #fff;
                padding: 20px;
                transition: right 0.3s ease;
                z-index: 1000;
            }

            #sidebar.active {
                right: 0; /* Shown when active */
            }

            #sidebar h3 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            #sidebar .friend-list,
            #sidebar .friend-request-list {
                margin-bottom: 20px;
            }

            #sidebar .friend-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                padding: 10px;
                background-color: #444;
                border-radius: 5px;
            }

            #sidebar .friend-item span {
                font-size: 14px;
            }

            #sidebar .friend-item .status {
                margin-left: 10px;
                font-size: 12px;
                font-weight: bold;
            }

            #sidebar .error-message {
                color: red;
                margin-top: 10px;
            }

            /* Hamburger button styles */
            .hamburger {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1100;
                cursor: pointer;
                font-size: 20px;
                color: #333;
            }

            .hamburger.active {
                color: #fff;
                background-color: #333;
            }

            .hamburger:hover {
                transform: scale(1.1);
            }

            /* Dropdown styles */
            .dropdown {
                position: relative;
                display: inline-block;
            }

            .dropdown-content {
                display: none;
                position: absolute;
                bottom: -10px;
                right: 0;
                transform: translate(8%, 100%);
                background-color: #444;
                color: white;
                min-width: 120px;
                box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                border-radius: 5px;
            }

            .dropdown-content a {
                color: white;
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                border-bottom: 1px solid #555;
            }

            .dropdown-content a:last-child {
                border-bottom: none;
            }

            .dropdown-content a:hover {
                background-color: #666;
            }

            .dropdown.active .dropdown-content {
                display: block;
            }

            .dropdown i {
                cursor: pointer;
                font-size: 18px;
            }
        </style>
    </head>
    <body>
    <div id="sidebar">
        <h3>Add Friend</h3>
        <form id="addFriendForm">
            <input type="text" id="friendNickname" class="form-control mb-2" placeholder="Enter nickname" required>
            <button type="submit" class="btn btn-success w-100">Add</button>
            <div id="friendError" class="error-message"></div>
        </form>
        <hr>
        <h3>Friend Requests</h3>
        <div class="friend-request-list" id="friendRequestList">
            <!-- Friend requests will be dynamically loaded here -->
        </div>
        <hr>
        <h3>Friend List</h3>
        <div class="friend-list" id="friendList">
            <!-- Friend list will be dynamically loaded here -->
        </div>
    </div>

    <!-- Hamburger Button -->
    <div class="hamburger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <script>
        const stompClient = null;

        // Toggle sidebar visibility
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.hamburger').classList.toggle('active');
        }

        // Fetch and display friend list
        function fetchFriendList() {
            fetch('/friend/list')
                .then(response => response.json())
                .then(friends => {
                    const friendList = document.getElementById('friendList');
                    friendList.innerHTML = '';

                    friends.forEach(friend => {
                        const friendItem = document.createElement('div');
                        friendItem.className = 'friend-item';
                        friendItem.innerHTML = `
                                    <span>${friend.friend_nickname}</span>
                                    <span class="status" style="color: ${friend.status ? 'green' : 'red'}">${friend.status ? 'Online' : 'Offline'}</span>
                                    <div class="dropdown">
                                        <i class="fas fa-cog" onclick="toggleDropdown(event)"></i>
                                        <div class="dropdown-content">
                                            <a href="javascript:void(0);" onclick="viewFriendDetails('${friend.id}')">View Details</a>
                                            <a href="javascript:void(0);" onclick="deleteFriend('${friend.id}')">Delete</a>
                                        </div>
                                    </div>
                                `;
                        friendList.appendChild(friendItem);
                    });
                })
                .catch(error => console.error('Error fetching friends:', error));
        }

        // Add friend
        document.getElementById('addFriendForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const nickname = document.getElementById('friendNickname').value;
            document.getElementById('friendError').textContent = '';

            fetch('/friend/plus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nickname })
            })
                .then(response => response.json())
                .then(result => {
                    alert(result.message);
                    document.getElementById('addFriendForm').reset();
                    fetchFriendList();
                })
                .catch(error => {
                    document.getElementById('friendError').textContent = 'Error adding friend';
                    console.error('Error adding friend:', error);
                });
        });

        // Fetch friend requests
        function fetchFriendRequests() {
            fetch('/friend/plus-list')
                .then(response => response.json())
                .then(requests => {
                    const requestList = document.getElementById('friendRequestList');
                    requestList.innerHTML = '';

                    requests.forEach(request => {
                        const requestItem = document.createElement('div');
                        requestItem.className = 'friend-item';
                        requestItem.innerHTML = `
                                    <span>${request.friend_nickname}</span>
                                    <div>
                                        <button class="btn btn-success btn-sm" onclick="handleFriendRequest('${request.id}', true)">O</button>
                                        <button class="btn btn-danger btn-sm" onclick="handleFriendRequest('${request.id}', false)">X</button>
                                    </div>
                                `;
                        requestList.appendChild(requestItem);
                    });
                })
                .catch(error => console.error('Error fetching friend requests:', error));
        }

        // Handle friend requests
        function handleFriendRequest(friendId, isAccepted) {
            fetch(`/friend/plus/${friendId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isAccepted })
            })
                .then(response => response.json())
                .then(result => {
                    alert(result.message);
                    fetchFriendRequests();
                    fetchFriendList();
                })
                .catch(error => console.error('Error handling friend request:', error));
        }

        // Real-time friend status update using WebSocket
        function connectWebSocket() {
            const socket = new SockJS('/friendsSocket');
            const stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                console.log('Connected to WebSocket');

                // Subscribe to the status update topic
                stompClient.subscribe('/user/queue/status', function (message) {
                    const statusUpdate = JSON.parse(message.body);
                    updateFriendStatus(statusUpdate.userId, statusUpdate.status);
                });
            }, function (error) {
                console.error('WebSocket connection error:', error);
            });
        }

        // Update the status of a friend in the friend list
        function updateFriendStatus(userId, status) {
            const friendItems = document.querySelectorAll('#friendList .friend-item');

            friendItems.forEach(item => {
                const nicknameElement = item.querySelector('span');
                const userIdMatch = item.dataset.userId;

                if (userIdMatch === userId) {
                    const statusElement = item.querySelector('.status');
                    statusElement.textContent = status ? 'Online' : 'Offline';
                    statusElement.style.color = status ? 'green' : 'red';
                }
            });
        }

        // Initialize WebSocket connection and fetch initial data
        document.addEventListener('DOMContentLoaded', function () {
            connectWebSocket();
            fetchFriendList();
            fetchFriendRequests();
        });

        // Dropdown toggle
        function toggleDropdown(event) {
            const dropdown = event.target.closest('.dropdown');
            dropdown.classList.toggle('active');
        }

        // View friend details
        function viewFriendDetails(friendId) {
            alert('Feature coming soon for friend ID: ' + friendId);
        }

        // Delete a friend
        function deleteFriend(friendId) {
            if (confirm('Are you sure you want to delete this friend?')) {
                fetch(`/friend/delete/${friendId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                        alert(result.message);
                        fetchFriendList();
                    })
                    .catch(error => console.error('Error deleting friend:', error));
            }
        }
    </script>
    </body>
</th:block>
</html>
